# Danngam MVP 패턴 개발 가이드

## 문서 정보

- **버전**: 1.0
- **작성일**: 2026-02-14
- **최종 수정일**: 2026-02-14
- **대상 독자**: Flutter 개발자
- **목적**: Danngam 프로젝트의 MVP 패턴 구현에 대한 개발자 가이드

---

## 1. 개발 환경 설정

### 1.1 필수 소프트웨어

- **Flutter SDK**: 3.10.8 이상
- **Dart**: 3.10.8 이상 (Flutter에 포함)
- **IDE**: VS Code 또는 Android Studio (추천)
- **Git**: 2.30 이상

### 1.2 IDE 및 확장 프로그램

#### VS Code 필수 확장
```
- Dart (publisher: Dart Code)
- Flutter (publisher: Dart Code)
- REST Client (선택사항, API 테스트용)
- Pubspec Assist (선택사항)
```

#### Android Studio의 경우
```
- Flutter 플러그인
- Dart 플러그인
```

### 1.3 시뮬레이터/에뮬레이터 설정

#### Android 에뮬레이터
```bash
flutter emulators
flutter emulators --launch <emulator_name>
```

#### iOS 시뮬레이터 (macOS만 해당)
```bash
flutter emulators
open -a Simulator
```

---

## 2. 프로젝트 시작하기

### 2.1 초기 설정

```bash
# 1. 레포지토리 클론
git clone https://github.com/danngam/danngam.git
cd danngam_app

# 2. 의존성 설치
flutter pub get

# 3. 환경 변수 설정
cp .env.example .env

# 4. 코드 생성 (Freezed, Riverpod 등)
flutter pub run build_runner build --delete-conflicting-outputs

# 5. 앱 실행
flutter run
```

### 2.2 개발용 명령어

```bash
# 명령 라인 옵션과 함께 실행
flutter run -v                              # 자세한 로그 출력
flutter run --debug                         # 디버그 모드
flutter run --release                       # 릴리스 모드
flutter run -d <device_id>                  # 특정 디바이스에서 실행

# 코드 분석 및 형식화
flutter analyze                              # 코드 분석
dart format lib/                             # 코드 형식화 (VS Code에서 save 시 자동)
flutter clean                                # 빌드 캐시 초기화
```

---

## 3. 환경 변수 설정 (.env)

프로젝트 루트에 `.env` 파일을 생성하고 다음 변수를 설정합니다.

```bash
# .env 파일 예제

# API 서버 설정
API_BASE_URL=https://api.danngam.com
API_TIMEOUT=30000                           # 밀리초 단위

# 백엔드 선택 (Supabase 또는 Firebase)
BACKEND_TYPE=supabase                       # 'supabase' 또는 'firebase'

# Supabase 설정
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=eyJhbGc...                     # Anonymous Key
SUPABASE_JWT_SECRET=your-jwt-secret         # (서버에서만 사용)

# Firebase 설정 (선택사항)
FIREBASE_PROJECT_ID=danngam-prod
FIREBASE_API_KEY=AIzaSyD...

# 결제 게이트웨이
PAYMENT_GATEWAY=iamport                     # 'iamport' 또는 'toss'
IAMPORT_API_KEY=your-iamport-api-key

# 기타 설정
LOG_LEVEL=debug                             # 'debug', 'info', 'warning', 'error'
ENABLE_ANALYTICS=true
```

### 3.1 환경 변수 로드

```dart
// lib/core/config/env.dart
import 'package:flutter_dotenv/flutter_dotenv.dart';

class AppConfig {
  static final instance = AppConfig._();

  AppConfig._();

  late final String apiBaseUrl;
  late final String supabaseUrl;
  late final String supabaseKey;
  late final int apiTimeout;

  Future<void> load() async {
    await dotenv.load(fileName: '.env');
    apiBaseUrl = dotenv.env['API_BASE_URL'] ?? 'https://api.danngam.com';
    supabaseUrl = dotenv.env['SUPABASE_URL'] ?? '';
    supabaseKey = dotenv.env['SUPABASE_KEY'] ?? '';
    apiTimeout = int.parse(dotenv.env['API_TIMEOUT'] ?? '30000');
  }
}
```

---

## 4. 코딩 컨벤션

### 4.1 일반 원칙

- **언어**: 영어 (클래스, 메서드, 변수명)
- **주석**: 한국어 가능
- **포맷팅**: Dart Style Guide 준수
- **들여쓰기**: 2칸 (탭 금지)

### 4.2 네이밍 규칙

```dart
// 클래스: PascalCase
class EquipmentPresenter { }
class ApiClient { }

// 상수: camelCase (final)
const maxRetryCount = 3;
final apiTimeout = Duration(seconds: 30);

// 변수/메서드: camelCase
String equipmentName = '';
void loadEquipment() { }
bool isLoading = false;

// 파일명: snake_case
equipment_presenter.dart
equipment_repository.dart
main_screen.dart

// 폴더명: snake_case
lib/
├── screens/
├── models/
├── presenters/
├── repositories/
└── widgets/

// Private 멤버: 언더스코어 접두사
class EquipmentPresenter {
  String _privateField;
  void _privateMethod() { }
}

// Enum: PascalCase (멤버는 UPPER_CASE)
enum EquipmentType {
  MOBILE,  // 이동형
  FIXED    // 고정형
}

// 위젯: Stateless/Stateful는 클래스명에 'Screen' 또는 'Widget' 포함
class MainScreen extends StatefulWidget { }
class EquipmentCard extends StatelessWidget { }
```

### 4.3 폴더 구조 (기능별 분류)

```
lib/
├── main.dart                          # 앱 진입점
├── core/
│   ├── config/
│   │   ├── env.dart                   # 환경 변수
│   │   └── theme.dart                 # 테마 설정
│   ├── errors/
│   │   └── exceptions.dart            # 커스텀 예외
│   ├── network/
│   │   ├── api_client.dart            # HTTP 클라이언트
│   │   └── dio_interceptors.dart      # 인터셉터
│   └── utils/
│       ├── logger.dart
│       └── validators.dart
├── features/
│   ├── auth/
│   │   ├── data/
│   │   │   ├── models/
│   │   │   ├── datasources/
│   │   │   └── repositories/
│   │   ├── domain/
│   │   │   ├── entities/
│   │   │   └── usecases/
│   │   └── presentation/
│   │       ├── screens/
│   │       ├── widgets/
│   │       └── presenters/
│   ├── equipment/
│   │   ├── data/
│   │   ├── domain/
│   │   └── presentation/
│   └── booking/
│       ├── data/
│       ├── domain/
│       └── presentation/
└── shared/
    ├── widgets/
    │   ├── app_button.dart
    │   ├── app_text_field.dart
    │   ├── equipment_card.dart
    │   ├── filter_bottom_sheet.dart
    │   ├── loading_indicator.dart
    │   └── error_view.dart
    └── models/
        └── pagination_model.dart
```

---

## 4.4 모듈별 개발 전략 (⭐ 중요)

### 목적

**각 기능을 독립적인 모듈로 개발하여:**
- ✅ MVP 기능을 쉽게 추가/제거 가능
- ✅ 기능 간 의존성 최소화
- ✅ 향후 기능 확장 시 기존 코드 영향 최소화
- ✅ 개별 모듈 테스트 용이

### 모듈 정의

각 주요 기능을 **독립적인 모듈**로 구현합니다:

| 모듈 | 폴더명 | 설명 | 필수 | 의존성 |
|------|--------|------|------|--------|
| 인증 | `auth_module` | 로그인/회원가입 | ✅ | 없음 |
| 장비 | `equipment_module` | 장비 검색/상세 | ✅ | auth |
| 예약 | `booking_module` | 예약 요청/수락/거절 | ✅ | equipment |
| 채팅 | `chat_module` | 1:1 채팅 | ⭐ | auth |
| 지도 | `map_module` | 지도 검색 | ⭐ | equipment |
| 리뷰 | `review_module` | 리뷰 작성 | ⭐ | booking |

**⭐ = MVP에서 제거 가능한 모듈**

### 모듈 폴더 구조

```
lib/modules/{module_name}/
├── contracts/
│   └── {module}_contract.dart           # View/Presenter 인터페이스
├── presenters/
│   └── {module}_presenter.dart          # 비즈니스 로직
├── screens/
│   └── {module}_screen.dart             # UI 화면
├── repositories/
│   └── {module}_repository.dart         # 데이터 소스 추상화
├── models/
│   ├── {module}_model.dart              # 데이터 모델
│   └── {module}_entity.dart             # 엔티티
├── providers/
│   └── {module}_provider.dart           # Provider (상태관리)
└── {module}_module.dart                 # 모듈 export (⭐ 중요)
```

**모듈 export 파일 예제**:
```dart
// lib/modules/equipment_module/equipment_module.dart
export 'contracts/equipment_contract.dart';
export 'screens/equipment_list_screen.dart';
export 'screens/equipment_detail_screen.dart';
export 'providers/equipment_provider.dart';
```

### 모듈 간 의존성 관리

**의존성 규칙**:
1. **화살표는 한 방향만** (상위 → 하위로만 가능)
   ```
   auth_module
      ↓
   equipment_module
      ↓
   booking_module
   ```

2. **모듈은 export 파일로만 노출**
   ```dart
   // ✅ 좋음 - export 파일 import
   import 'modules/equipment_module/equipment_module.dart';

   // ❌ 나쁨 - 내부 파일 직접 import
   import 'modules/equipment_module/screens/equipment_screen.dart';
   ```

3. **상위 모듈은 하위 모듈만 import**
   ```dart
   // booking_module (상위)

   // ✅ 좋음
   import 'modules/equipment_module/equipment_module.dart'; // 하위 모듈

   // ❌ 나쁨
   import 'modules/chat_module/chat_module.dart'; // 같은 레벨 모듈
   ```

### Feature Flag 구현 (기능 활성화/비활성화)

모듈을 선택적으로 활성화할 수 있게 Feature Flag를 정의합니다:

```dart
// lib/config/feature_flags.dart
class FeatureFlags {
  // 필수 모듈
  static const bool enableAuth = true;

  // MVP 필수
  static const bool enableEquipment = true;
  static const bool enableBooking = true;

  // MVP 선택사항 (제거 가능)
  static const bool enableChat = true;      // 채팅 비활성화 가능
  static const bool enableMap = true;       // 지도 비활성화 가능
  static const bool enableReview = true;    // 리뷰 비활성화 가능
}
```

### main.dart에서 모듈 초기화

```dart
// lib/main.dart
import 'config/feature_flags.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // 필수 모듈 초기화 (항상 실행)
  setupAuthModule();
  setupEquipmentModule();
  setupBookingModule();

  // 선택적 모듈 (Feature Flag 확인)
  if (FeatureFlags.enableChat) setupChatModule();
  if (FeatureFlags.enableMap) setupMapModule();
  if (FeatureFlags.enableReview) setupReviewModule();

  runApp(const DangamApp());
}

// 각 모듈의 초기화 함수
void setupAuthModule() {
  // AuthProvider 등록
  // AuthRepository 등록
}

void setupEquipmentModule() {
  // EquipmentProvider 등록
  // EquipmentRepository 등록
}

// ... 나머지 모듈도 동일
```

### 네비게이션에서 모듈 활용

```dart
// lib/routes/app_router.dart
class AppRouter {
  static Route<dynamic> onGenerateRoute(RouteSettings settings) {
    switch (settings.name) {
      case '/auth':
        return MaterialPageRoute(builder: (_) => const LoginScreen());

      case '/equipment':
        return MaterialPageRoute(builder: (_) => const EquipmentListScreen());

      // 선택적 모듈은 Feature Flag 확인
      case '/chat':
        if (FeatureFlags.enableChat) {
          return MaterialPageRoute(builder: (_) => const ChatScreen());
        }
        return MaterialPageRoute(builder: (_) => const ErrorScreen());

      case '/map':
        if (FeatureFlags.enableMap) {
          return MaterialPageRoute(builder: (_) => const MapSearchScreen());
        }
        return MaterialPageRoute(builder: (_) => const ErrorScreen());

      default:
        return MaterialPageRoute(builder: (_) => const NotFoundScreen());
    }
  }
}
```

### 모듈 제거 시 절차

**예: 리뷰 모듈 제거**

1. **Feature Flag 비활성화**
   ```dart
   static const bool enableReview = false;  // false로 변경
   ```

2. **import 제거** (setupReviewModule() 호출 제거)
   ```dart
   // main.dart에서 다음 줄 제거
   // if (FeatureFlags.enableReview) setupReviewModule();
   ```

3. **라우터에서 제거**
   ```dart
   // '/review' 라우트 제거
   ```

4. **모듈 폴더 삭제** (선택사항)
   ```bash
   rm -rf lib/modules/review_module
   ```

5. **테스트**
   ```bash
   flutter clean
   flutter pub get
   flutter run
   ```

**결과**: 다른 모듈에는 영향 없이 리뷰 기능만 완전히 제거됨 ✅

### 모듈별 개발 체크리스트

```markdown
# 새 모듈 개발 시 확인 사항

## 구조
- [ ] `lib/modules/{module_name}/` 폴더 생성
- [ ] 위 구조에 맞는 파일들 생성
- [ ] `{module}_module.dart` export 파일 생성

## 구현
- [ ] Contract Interface 정의
- [ ] Presenter 구현
- [ ] View 구현
- [ ] Repository 구현
- [ ] Provider 구현

## 의존성
- [ ] 상위 모듈만 import (상위 → 하위)
- [ ] export 파일로만 노출
- [ ] 순환 의존성 없음

## Feature Flag
- [ ] Feature Flag 추가 (필요시)
- [ ] main.dart에서 조건부 초기화
- [ ] 라우터에서 조건부 로드

## 테스트
- [ ] 모듈이 활성화되었을 때 정상 작동
- [ ] 모듈이 비활성화되었을 때 영향 없음
- [ ] 모듈 삭제 후에도 다른 기능 정상 작동
```

---

## 5. MVP 패턴 구현 체크리스트

### 5.1 MVP 패턴 개요

MVP (Model-View-Presenter) 패턴은 다음 세 가지 계층으로 구성됩니다.

- **Model**: 데이터 및 비즈니스 로직 (Repository, Entity)
- **View**: UI 표시 (StatefulWidget)
- **Presenter**: Model과 View를 연결하는 로직 (비즈니스 로직 처리)

```
┌─────────────────────────────────────────┐
│         View (StatefulWidget)           │
│  - UI 렌더링                             │
│  - 사용자 입력 감지                      │
└─────────────────────┬───────────────────┘
                      │ 상호작용
                      ↕
┌─────────────────────────────────────────┐
│         Presenter (Controller)           │
│  - 비즈니스 로직 처리                    │
│  - View 상태 관리                        │
└─────────────────────┬───────────────────┘
                      │ 데이터 요청
                      ↕
┌─────────────────────────────────────────┐
│    Model (Repository + DataSource)      │
│  - 데이터 가져오기 (API, 로컬 DB)       │
│  - 데이터 변환                          │
└─────────────────────────────────────────┘
```

### 5.2 구현 체크리스트

```markdown
# 새로운 기능 구현 시 확인 사항

## Contract Interface 작성
- [ ] `[Feature]Contract.dart` 파일 생성
- [ ] `[Feature]View` interface 정의 (View가 구현해야 할 메서드)
- [ ] `[Feature]Presenter` interface 정의 (Presenter가 구현해야 할 메서드)

## Presenter 구현
- [ ] Presenter 클래스 생성 및 Contract 구현
- [ ] Repository 의존성 주입 (생성자)
- [ ] 비즈니스 로직 메서드 작성 (loadData, saveData 등)
- [ ] 예외 처리 (try-catch)
- [ ] View 콜백 호출 (onSuccess, onError, onLoading)

## View 구현
- [ ] StatefulWidget 또는 StatelessWidget 생성
- [ ] Contract View interface 구현
- [ ] Presenter 초기화 (initState)
- [ ] UI 상태 변수 (isLoading, errorMessage 등)
- [ ] build() 메서드에서 상태에 따른 UI 렌더링
- [ ] Presenter 콜백 메서드 구현

## Repository 구현
- [ ] Repository interface 정의 (추상 클래스)
- [ ] Repository 구현 클래스 생성
- [ ] DataSource 의존성 주입
- [ ] 데이터 변환 로직 (Entity ↔ DTO)
- [ ] 에러 처리 및 예외 발생

## Dependency Injection
- [ ] GetIt을 사용한 의존성 등록
- [ ] main.dart 또는 별도 파일에서 setup_service_locator() 호출
- [ ] Singleton 패턴 적용 (공유 리소스)

## 테스트 작성
- [ ] Unit 테스트 (Presenter 및 Repository)
- [ ] Widget 테스트 (View)
- [ ] Mock 객체 생성 (mockito)
- [ ] 100% 코드 커버리지 목표
```

---

## 6. MVP 패턴 구현 예제

### 6.1 Contract 정의

```dart
// lib/features/equipment/presentation/contracts/equipment_contract.dart

/// Equipment View가 구현해야 할 인터페이스
abstract class EquipmentView {
  void showLoading();
  void hideLoading();
  void showEquipmentList(List<Equipment> equipments);
  void showError(String message);
  void navigateToDetail(String equipmentId);
}

/// Equipment Presenter가 구현해야 할 인터페이스
abstract class EquipmentPresenter {
  void loadEquipment({
    required EquipmentType type,
    String? searchQuery,
    String? sortBy,
  });
  void filterByCategory(String category);
  void onEquipmentTap(String equipmentId);
}
```

### 6.2 Presenter 구현

```dart
// lib/features/equipment/presentation/presenters/equipment_presenter.dart

import 'package:danngam/features/equipment/domain/repositories/equipment_repository.dart';
import 'equipment_contract.dart';

class EquipmentPresenterImpl implements EquipmentPresenter {
  final EquipmentRepository _repository;
  late EquipmentView _view;

  EquipmentPresenterImpl(this._repository);

  void setView(EquipmentView view) {
    _view = view;
  }

  @override
  void loadEquipment({
    required EquipmentType type,
    String? searchQuery,
    String? sortBy,
  }) async {
    try {
      _view.showLoading();

      // Repository에서 데이터 조회
      final equipments = await _repository.getEquipment(
        type: type,
        searchQuery: searchQuery,
        sortBy: sortBy,
      );

      _view.hideLoading();
      _view.showEquipmentList(equipments);
    } on ApiException catch (e) {
      _view.hideLoading();
      _view.showError('API 오류: ${e.message}');
    } on Exception catch (e) {
      _view.hideLoading();
      _view.showError('오류 발생: ${e.toString()}');
    }
  }

  @override
  void filterByCategory(String category) {
    loadEquipment(
      type: EquipmentType.MOBILE,
      searchQuery: category,
    );
  }

  @override
  void onEquipmentTap(String equipmentId) {
    _view.navigateToDetail(equipmentId);
  }
}
```

### 6.3 View 구현

```dart
// lib/features/equipment/presentation/screens/equipment_screen.dart

import 'package:flutter/material.dart';
import 'package:get_it/get_it.dart';
import '../contracts/equipment_contract.dart';
import '../presenters/equipment_presenter.dart';

class EquipmentScreen extends StatefulWidget {
  const EquipmentScreen({Key? key}) : super(key: key);

  @override
  State<EquipmentScreen> createState() => _EquipmentScreenState();
}

class _EquipmentScreenState extends State<EquipmentScreen>
    implements EquipmentView {
  late EquipmentPresenter _presenter;
  bool _isLoading = false;
  List<Equipment> _equipments = [];
  String? _errorMessage;
  EquipmentType _selectedType = EquipmentType.MOBILE;

  @override
  void initState() {
    super.initState();
    _presenter = GetIt.instance<EquipmentPresenter>();
    (_presenter as dynamic).setView(this);
    _presenter.loadEquipment(type: _selectedType);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('장비 검색'),
      ),
      body: Column(
        children: [
          // 탭 버튼
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Row(
              children: [
                Expanded(
                  child: _buildTabButton('이동형', EquipmentType.MOBILE),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: _buildTabButton('고정형', EquipmentType.FIXED),
                ),
              ],
            ),
          ),
          // 컨텐츠
          Expanded(
            child: _buildContent(),
          ),
        ],
      ),
    );
  }

  Widget _buildTabButton(String label, EquipmentType type) {
    final isSelected = _selectedType == type;
    return ElevatedButton(
      onPressed: () {
        setState(() => _selectedType = type);
        _presenter.loadEquipment(type: type);
      },
      style: ElevatedButton.styleFrom(
        backgroundColor: isSelected ? Colors.blue : Colors.grey[300],
      ),
      child: Text(
        label,
        style: TextStyle(
          color: isSelected ? Colors.white : Colors.black,
        ),
      ),
    );
  }

  Widget _buildContent() {
    if (_isLoading) {
      return const Center(child: CircularProgressIndicator());
    }

    if (_errorMessage != null) {
      return ErrorView(
        message: _errorMessage!,
        onRetry: () => _presenter.loadEquipment(type: _selectedType),
      );
    }

    if (_equipments.isEmpty) {
      return const Center(child: Text('장비가 없습니다.'));
    }

    return ListView.builder(
      itemCount: _equipments.length,
      itemBuilder: (context, index) {
        final equipment = _equipments[index];
        return EquipmentCard(
          equipment: equipment,
          onTap: () => _presenter.onEquipmentTap(equipment.id),
        );
      },
    );
  }

  @override
  void showLoading() {
    setState(() => _isLoading = true);
  }

  @override
  void hideLoading() {
    setState(() => _isLoading = false);
  }

  @override
  void showEquipmentList(List<Equipment> equipments) {
    setState(() {
      _equipments = equipments;
      _errorMessage = null;
    });
  }

  @override
  void showError(String message) {
    setState(() => _errorMessage = message);
  }

  @override
  void navigateToDetail(String equipmentId) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => EquipmentDetailScreen(
          equipmentId: equipmentId,
        ),
      ),
    );
  }
}
```

### 6.4 Repository 구현

```dart
// lib/features/equipment/domain/repositories/equipment_repository.dart

abstract class EquipmentRepository {
  Future<List<Equipment>> getEquipment({
    required EquipmentType type,
    String? searchQuery,
    String? sortBy,
  });

  Future<Equipment> getEquipmentDetail(String id);
}

// lib/features/equipment/data/repositories/equipment_repository_impl.dart

class EquipmentRepositoryImpl implements EquipmentRepository {
  final EquipmentRemoteDataSource _remoteDataSource;
  final EquipmentLocalDataSource _localDataSource;

  EquipmentRepositoryImpl(
    this._remoteDataSource,
    this._localDataSource,
  );

  @override
  Future<List<Equipment>> getEquipment({
    required EquipmentType type,
    String? searchQuery,
    String? sortBy,
  }) async {
    try {
      // 원격 데이터 소스에서 조회
      final equipmentDtos = await _remoteDataSource.getEquipment(
        type: type.name,
        searchQuery: searchQuery,
        sortBy: sortBy,
      );

      // DTO를 Entity로 변환
      final equipments = equipmentDtos
          .map((dto) => dto.toEntity())
          .toList();

      // 로컬 캐시에 저장 (선택사항)
      await _localDataSource.cacheEquipment(equipments);

      return equipments;
    } on ApiException catch (e) {
      // 네트워크 오류 시 캐시된 데이터 반환
      final cachedEquipments = await _localDataSource.getCachedEquipment();
      if (cachedEquipments.isNotEmpty) {
        return cachedEquipments;
      }
      rethrow;
    }
  }

  @override
  Future<Equipment> getEquipmentDetail(String id) async {
    final dto = await _remoteDataSource.getEquipmentDetail(id);
    return dto.toEntity();
  }
}
```

### 6.5 Dependency Injection 설정

```dart
// lib/core/di/service_locator.dart

import 'package:get_it/get_it.dart';

final getIt = GetIt.instance;

void setupServiceLocator() {
  // Data Sources
  getIt.registerSingleton<EquipmentRemoteDataSource>(
    EquipmentRemoteDataSourceImpl(getIt<ApiClient>()),
  );

  getIt.registerSingleton<EquipmentLocalDataSource>(
    EquipmentLocalDataSourceImpl(getIt<LocalStorage>()),
  );

  // Repositories
  getIt.registerSingleton<EquipmentRepository>(
    EquipmentRepositoryImpl(
      getIt<EquipmentRemoteDataSource>(),
      getIt<EquipmentLocalDataSource>(),
    ),
  );

  // Presenters
  getIt.registerSingleton<EquipmentPresenter>(
    EquipmentPresenterImpl(getIt<EquipmentRepository>()),
  );

  // API Client
  getIt.registerSingleton<ApiClient>(
    DioClient(AppConfig.instance.apiBaseUrl),
  );
}

// main.dart에서 호출
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await AppConfig.instance.load();
  setupServiceLocator();
  runApp(const MyApp());
}
```

---

## 7. 이동형/고정형 장비 구분 처리 (핵심)

### 7.1 EquipmentType Enum 정의

```dart
// lib/features/equipment/domain/entities/equipment_type.dart

enum EquipmentType {
  MOBILE,  // 이동형 (트랙터, 콤바인, 임플 등)
  FIXED    // 고정형 (건조기, 저온저장고, 정미기 등)
}

extension EquipmentTypeExtension on EquipmentType {
  String get label {
    switch (this) {
      case EquipmentType.MOBILE:
        return '이동형';
      case EquipmentType.FIXED:
        return '고정형';
    }
  }

  IconData get icon {
    switch (this) {
      case EquipmentType.MOBILE:
        return Icons.directions_car;
      case EquipmentType.FIXED:
        return Icons.home;
    }
  }

  Color get backgroundColor {
    switch (this) {
      case EquipmentType.MOBILE:
        return const Color(0xFFE3F2FD);  // 연파랑
      case EquipmentType.FIXED:
        return const Color(0xFFE8F5E9);  // 연초록
    }
  }
}
```

### 7.2 Equipment 모델에 type 추가

```dart
// lib/features/equipment/domain/entities/equipment.dart

class Equipment {
  final String id;
  final String name;
  final String category;
  final EquipmentType type;  // 추가됨
  final String description;
  final double price;
  final String imageUrl;
  final double rating;
  final int reviewCount;
  final String providerId;
  final double latitude;
  final double longitude;
  final DateTime createdAt;

  Equipment({
    required this.id,
    required this.name,
    required this.category,
    required this.type,
    required this.description,
    required this.price,
    required this.imageUrl,
    required this.rating,
    required this.reviewCount,
    required this.providerId,
    required this.latitude,
    required this.longitude,
    required this.createdAt,
  });
}
```

### 7.3 MainScreen에 탭 구조 적용

```dart
// lib/features/equipment/presentation/screens/main_screen.dart

class MainScreen extends StatefulWidget {
  const MainScreen({Key? key}) : super(key: key);

  @override
  State<MainScreen> createState() => _MainScreenState();
}

class _MainScreenState extends State<MainScreen>
    with SingleTickerProviderStateMixin {
  late TabController _tabController;

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 2, vsync: this);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Danngam'),
        bottom: TabBar(
          controller: _tabController,
          tabs: const [
            Tab(
              icon: Icon(Icons.directions_car),
              text: '이동형 장비',
            ),
            Tab(
              icon: Icon(Icons.home),
              text: '고정형 장비',
            ),
          ],
        ),
      ),
      body: TabBarView(
        controller: _tabController,
        children: [
          EquipmentListScreen(type: EquipmentType.MOBILE),
          EquipmentListScreen(type: EquipmentType.FIXED),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }
}
```

### 7.4 필터링 로직

```dart
// lib/features/equipment/presentation/presenters/equipment_presenter.dart

class EquipmentPresenterImpl implements EquipmentPresenter {
  // ...

  @override
  void loadEquipment({
    required EquipmentType type,
    String? searchQuery,
    String? sortBy,
  }) async {
    try {
      _view.showLoading();

      // 장비 타입으로 필터링
      final equipments = await _repository.getEquipment(
        type: type,
        searchQuery: searchQuery,
        sortBy: sortBy,
      );

      // 추가 클라이언트 측 필터링 (선택사항)
      List<Equipment> filtered = equipments.where((e) => e.type == type).toList();

      // 정렬 적용
      if (sortBy == 'price') {
        filtered.sort((a, b) => a.price.compareTo(b.price));
      } else if (sortBy == 'rating') {
        filtered.sort((a, b) => b.rating.compareTo(a.rating));
      } else if (sortBy == 'distance') {
        // 위치 기반 정렬 (현재 위치와의 거리)
        filtered.sort((a, b) {
          final distA = _calculateDistance(a.latitude, a.longitude);
          final distB = _calculateDistance(b.latitude, b.longitude);
          return distA.compareTo(distB);
        });
      }

      _view.hideLoading();
      _view.showEquipmentList(filtered);
    } on Exception catch (e) {
      _view.hideLoading();
      _view.showError('오류: ${e.toString()}');
    }
  }

  double _calculateDistance(double lat, double lng) {
    // Haversine 공식을 사용한 거리 계산
    // 현재 위치는 _currentLocation에서 가져옴
    // (위치 서비스 통합 필요)
    return 0.0; // 구현 필요
  }
}
```

### 7.5 UI 구분 (아이콘, 배경색)

```dart
// lib/shared/widgets/equipment_card.dart

class EquipmentCard extends StatelessWidget {
  final Equipment equipment;
  final VoidCallback onTap;

  const EquipmentCard({
    Key? key,
    required this.equipment,
    required this.onTap,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Card(
        margin: const EdgeInsets.all(8.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // 이미지 + 타입 뱃지
            Stack(
              children: [
                Image.network(
                  equipment.imageUrl,
                  height: 200,
                  width: double.infinity,
                  fit: BoxFit.cover,
                ),
                Positioned(
                  top: 8,
                  right: 8,
                  child: Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 8,
                      vertical: 4,
                    ),
                    decoration: BoxDecoration(
                      color: equipment.type.backgroundColor,
                      borderRadius: BorderRadius.circular(4),
                    ),
                    child: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Icon(
                          equipment.type.icon,
                          size: 14,
                          color: _getIconColor(equipment.type),
                        ),
                        const SizedBox(width: 4),
                        Text(
                          equipment.type.label,
                          style: TextStyle(
                            fontSize: 12,
                            fontWeight: FontWeight.bold,
                            color: _getIconColor(equipment.type),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ],
            ),
            Padding(
              padding: const EdgeInsets.all(12.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    equipment.name,
                    style: const TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    equipment.category,
                    style: TextStyle(
                      fontSize: 12,
                      color: Colors.grey[600],
                    ),
                  ),
                  const SizedBox(height: 8),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Text(
                        '${equipment.price.toStringAsFixed(0)}원/일',
                        style: const TextStyle(
                          fontSize: 14,
                          fontWeight: FontWeight.bold,
                          color: Colors.blue,
                        ),
                      ),
                      Row(
                        children: [
                          const Icon(Icons.star, size: 14, color: Colors.amber),
                          const SizedBox(width: 4),
                          Text(
                            '${equipment.rating} (${equipment.reviewCount})',
                            style: const TextStyle(fontSize: 12),
                          ),
                        ],
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Color _getIconColor(EquipmentType type) {
    switch (type) {
      case EquipmentType.MOBILE:
        return Colors.blue;
      case EquipmentType.FIXED:
        return Colors.green;
    }
  }
}
```

---

## 8. 공통 컴포넌트 사용법

### 8.1 AppButton

```dart
// lib/shared/widgets/app_button.dart

class AppButton extends StatelessWidget {
  final String label;
  final VoidCallback onPressed;
  final bool isLoading;
  final bool isEnabled;

  const AppButton({
    Key? key,
    required this.label,
    required this.onPressed,
    this.isLoading = false,
    this.isEnabled = true,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      width: double.infinity,
      height: 48,
      child: ElevatedButton(
        onPressed: isEnabled && !isLoading ? onPressed : null,
        child: isLoading
            ? const SizedBox(
                height: 24,
                width: 24,
                child: CircularProgressIndicator(strokeWidth: 2),
              )
            : Text(label),
      ),
    );
  }
}

// 사용 예제
AppButton(
  label: '예약하기',
  isLoading: _isLoading,
  onPressed: () => _presenter.bookEquipment(),
)
```

### 8.2 AppTextField

```dart
// lib/shared/widgets/app_text_field.dart

class AppTextField extends StatefulWidget {
  final String hint;
  final String? label;
  final TextEditingController controller;
  final TextInputType keyboardType;
  final String? Function(String?)? validator;
  final int maxLines;
  final int? maxLength;
  final bool obscureText;
  final Widget? prefixIcon;
  final Widget? suffixIcon;

  const AppTextField({
    Key? key,
    required this.hint,
    this.label,
    required this.controller,
    this.keyboardType = TextInputType.text,
    this.validator,
    this.maxLines = 1,
    this.maxLength,
    this.obscureText = false,
    this.prefixIcon,
    this.suffixIcon,
  }) : super(key: key);

  @override
  State<AppTextField> createState() => _AppTextFieldState();
}

class _AppTextFieldState extends State<AppTextField> {
  late FocusNode _focusNode;
  bool _isFocused = false;

  @override
  void initState() {
    super.initState();
    _focusNode = FocusNode();
    _focusNode.addListener(() {
      setState(() => _isFocused = _focusNode.hasFocus);
    });
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        if (widget.label != null)
          Text(
            widget.label!,
            style: const TextStyle(
              fontWeight: FontWeight.w500,
              fontSize: 14,
            ),
          ),
        if (widget.label != null) const SizedBox(height: 8),
        TextFormField(
          controller: widget.controller,
          keyboardType: widget.keyboardType,
          validator: widget.validator,
          maxLines: widget.maxLines,
          maxLength: widget.maxLength,
          obscureText: widget.obscureText,
          focusNode: _focusNode,
          decoration: InputDecoration(
            hintText: widget.hint,
            prefixIcon: widget.prefixIcon,
            suffixIcon: widget.suffixIcon,
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(8),
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(8),
              borderSide: const BorderSide(
                color: Colors.blue,
                width: 2,
              ),
            ),
            contentPadding: const EdgeInsets.symmetric(
              horizontal: 16,
              vertical: 12,
            ),
          ),
        ),
      ],
    );
  }

  @override
  void dispose() {
    _focusNode.dispose();
    super.dispose();
  }
}

// 사용 예제
AppTextField(
  label: '이메일',
  hint: 'example@danngam.com',
  controller: _emailController,
  keyboardType: TextInputType.emailAddress,
  validator: (value) {
    if (value == null || value.isEmpty) {
      return '이메일을 입력해주세요.';
    }
    if (!value.contains('@')) {
      return '유효한 이메일 형식이 아닙니다.';
    }
    return null;
  },
  prefixIcon: const Icon(Icons.email),
)
```

### 8.3 EquipmentCard

```dart
// 위의 섹션 7.5 참조
```

### 8.4 FilterBottomSheet

```dart
// lib/shared/widgets/filter_bottom_sheet.dart

class FilterBottomSheet extends StatefulWidget {
  final Function(FilterOptions) onApply;
  final FilterOptions? initialOptions;

  const FilterBottomSheet({
    Key? key,
    required this.onApply,
    this.initialOptions,
  }) : super(key: key);

  @override
  State<FilterBottomSheet> createState() => _FilterBottomSheetState();
}

class _FilterBottomSheetState extends State<FilterBottomSheet> {
  late RangeValues _priceRange;
  String? _selectedCategory;
  String? _selectedSortBy;

  @override
  void initState() {
    super.initState();
    _priceRange = widget.initialOptions?.priceRange ?? const RangeValues(0, 1000000);
    _selectedCategory = widget.initialOptions?.category;
    _selectedSortBy = widget.initialOptions?.sortBy;
  }

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      child: Container(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // 헤더
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Text(
                  '필터',
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                GestureDetector(
                  onTap: () => Navigator.pop(context),
                  child: const Icon(Icons.close),
                ),
              ],
            ),
            const SizedBox(height: 24),
            // 가격 범위
            Text(
              '가격 범위',
              style: Theme.of(context).textTheme.bodyLarge,
            ),
            RangeSlider(
              values: _priceRange,
              min: 0,
              max: 1000000,
              divisions: 100,
              labels: RangeLabels(
                '${_priceRange.start.toInt()}원',
                '${_priceRange.end.toInt()}원',
              ),
              onChanged: (value) {
                setState(() => _priceRange = value);
              },
            ),
            const SizedBox(height: 24),
            // 카테고리
            Text(
              '카테고리',
              style: Theme.of(context).textTheme.bodyLarge,
            ),
            ..._buildCategoryChips(),
            const SizedBox(height: 24),
            // 정렬
            Text(
              '정렬',
              style: Theme.of(context).textTheme.bodyLarge,
            ),
            ..._buildSortOptions(),
            const SizedBox(height: 24),
            // 버튼
            Row(
              children: [
                Expanded(
                  child: OutlinedButton(
                    onPressed: () => Navigator.pop(context),
                    child: const Text('취소'),
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: ElevatedButton(
                    onPressed: _onApply,
                    child: const Text('적용'),
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  List<Widget> _buildCategoryChips() {
    final categories = ['트랙터', '콤바인', '임플', '건조기', '저온저장고'];
    return [
      Wrap(
        spacing: 8,
        children: categories
            .map(
              (category) => FilterChip(
                label: Text(category),
                selected: _selectedCategory == category,
                onSelected: (selected) {
                  setState(() {
                    _selectedCategory = selected ? category : null;
                  });
                },
              ),
            )
            .toList(),
      ),
    ];
  }

  List<Widget> _buildSortOptions() {
    return [
      RadioListTile<String>(
        title: const Text('거리순'),
        value: 'distance',
        groupValue: _selectedSortBy,
        onChanged: (value) {
          setState(() => _selectedSortBy = value);
        },
      ),
      RadioListTile<String>(
        title: const Text('가격순 (낮음)'),
        value: 'price_asc',
        groupValue: _selectedSortBy,
        onChanged: (value) {
          setState(() => _selectedSortBy = value);
        },
      ),
      RadioListTile<String>(
        title: const Text('평점순'),
        value: 'rating',
        groupValue: _selectedSortBy,
        onChanged: (value) {
          setState(() => _selectedSortBy = value);
        },
      ),
    ];
  }

  void _onApply() {
    final options = FilterOptions(
      priceRange: _priceRange,
      category: _selectedCategory,
      sortBy: _selectedSortBy,
    );
    widget.onApply(options);
    Navigator.pop(context);
  }
}

// 모델
class FilterOptions {
  final RangeValues priceRange;
  final String? category;
  final String? sortBy;

  FilterOptions({
    required this.priceRange,
    this.category,
    this.sortBy,
  });
}

// 사용 예제
showModalBottomSheet(
  context: context,
  builder: (context) => FilterBottomSheet(
    onApply: (options) {
      _presenter.loadEquipment(
        type: _selectedType,
        minPrice: options.priceRange.start.toInt(),
        maxPrice: options.priceRange.end.toInt(),
        category: options.category,
        sortBy: options.sortBy,
      );
    },
  ),
)
```

### 8.5 LoadingIndicator

```dart
// lib/shared/widgets/loading_indicator.dart

class LoadingIndicator extends StatelessWidget {
  final String? message;

  const LoadingIndicator({Key? key, this.message}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const CircularProgressIndicator(),
          if (message != null) ...[
            const SizedBox(height: 16),
            Text(message!),
          ],
        ],
      ),
    );
  }
}

// 사용 예제
if (isLoading) {
  return LoadingIndicator(message: '데이터를 불러오는 중입니다...');
}
```

### 8.6 ErrorView

```dart
// lib/shared/widgets/error_view.dart

class ErrorView extends StatelessWidget {
  final String message;
  final VoidCallback? onRetry;
  final String? retryLabel;

  const ErrorView({
    Key? key,
    required this.message,
    this.onRetry,
    this.retryLabel,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const Icon(
            Icons.error_outline,
            size: 64,
            color: Colors.red,
          ),
          const SizedBox(height: 16),
          Text(
            '오류 발생',
            style: Theme.of(context).textTheme.headlineSmall,
          ),
          const SizedBox(height: 8),
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 32),
            child: Text(
              message,
              textAlign: TextAlign.center,
              style: Theme.of(context).textTheme.bodyMedium,
            ),
          ),
          if (onRetry != null) ...[
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: onRetry,
              child: Text(retryLabel ?? '다시 시도'),
            ),
          ],
        ],
      ),
    );
  }
}

// 사용 예제
ErrorView(
  message: 'API 서버 연결에 실패했습니다.\n나중에 다시 시도해주세요.',
  onRetry: () => _presenter.loadEquipment(type: _selectedType),
  retryLabel: '새로고침',
)
```

---

## 9. API 통신

### 9.1 ApiClient 초기화 (DioClient)

```dart
// lib/core/network/dio_client.dart

import 'package:dio/dio.dart';

class DioClient {
  late final Dio _dio;
  final String baseUrl;
  final Duration timeout;

  DioClient(
    this.baseUrl, {
    this.timeout = const Duration(seconds: 30),
  }) {
    _initializeDio();
  }

  void _initializeDio() {
    _dio = Dio(BaseOptions(
      baseUrl: baseUrl,
      connectTimeout: timeout,
      receiveTimeout: timeout,
      sendTimeout: timeout,
      contentType: 'application/json',
      headers: {
        'Accept': 'application/json',
      },
    ));

    // 인터셉터 추가
    _dio.interceptors.addAll([
      AuthInterceptor(),
      LoggingInterceptor(),
      RetryInterceptor(_dio),
    ]);
  }

  Future<Response> get(
    String path, {
    Map<String, dynamic>? queryParameters,
  }) async {
    return _dio.get(path, queryParameters: queryParameters);
  }

  Future<Response> post(
    String path, {
    dynamic data,
  }) async {
    return _dio.post(path, data: data);
  }

  Future<Response> put(
    String path, {
    dynamic data,
  }) async {
    return _dio.put(path, data: data);
  }

  Future<Response> delete(String path) async {
    return _dio.delete(path);
  }
}
```

### 9.2 인터셉터

```dart
// lib/core/network/dio_interceptors.dart

// 로깅 인터셉터
class LoggingInterceptor extends Interceptor {
  @override
  void onRequest(RequestOptions options, RequestInterceptorHandler handler) {
    debugPrint('→ ${options.method} ${options.path}');
    debugPrint('Headers: ${options.headers}');
    if (options.data != null) {
      debugPrint('Body: ${options.data}');
    }
    super.onRequest(options, handler);
  }

  @override
  void onResponse(Response response, ResponseInterceptorHandler handler) {
    debugPrint('← ${response.statusCode} ${response.requestOptions.path}');
    super.onResponse(response, handler);
  }

  @override
  void onError(DioException err, ErrorInterceptorHandler handler) {
    debugPrint('✗ Error: ${err.message}');
    super.onError(err, handler);
  }
}

// 인증 인터셉터
class AuthInterceptor extends Interceptor {
  @override
  void onRequest(RequestOptions options, RequestInterceptorHandler handler) {
    // JWT 토큰 추가
    final token = getIt<AuthRepository>().getToken();
    if (token != null) {
      options.headers['Authorization'] = 'Bearer $token';
    }
    super.onRequest(options, handler);
  }
}

// 재시도 인터셉터
class RetryInterceptor extends Interceptor {
  final Dio _dio;
  static const maxRetries = 3;
  int _retryCount = 0;

  RetryInterceptor(this._dio);

  @override
  void onError(DioException err, ErrorInterceptorHandler handler) {
    if (shouldRetry(err) && _retryCount < maxRetries) {
      _retryCount++;
      debugPrint('Retrying... (${_retryCount}/$maxRetries)');

      handler.resolve(
        _dio.request(
          err.requestOptions.path,
          options: Options(
            method: err.requestOptions.method,
            headers: err.requestOptions.headers,
          ),
          data: err.requestOptions.data,
        ),
      );
    } else {
      _retryCount = 0;
      super.onError(err, handler);
    }
  }

  bool shouldRetry(DioException err) {
    // 네트워크 오류만 재시도
    return err.type == DioExceptionType.connectionTimeout ||
        err.type == DioExceptionType.receiveTimeout ||
        err.type == DioExceptionType.unknown;
  }
}
```

### 9.3 예외 처리

```dart
// lib/core/errors/exceptions.dart

class ApiException implements Exception {
  final String message;
  final int? statusCode;
  final dynamic originalError;

  ApiException({
    required this.message,
    this.statusCode,
    this.originalError,
  });

  @override
  String toString() => 'ApiException: $message (Status: $statusCode)';
}

class ConnectionException implements Exception {
  final String message;

  ConnectionException(this.message);

  @override
  String toString() => 'ConnectionException: $message';
}

class AuthException implements Exception {
  final String message;

  AuthException(this.message);

  @override
  String toString() => 'AuthException: $message';
}
```

---

## 10. 이미지 처리

### 10.1 CachedNetworkImage 사용

```dart
// lib/shared/widgets/cached_image.dart

import 'package:cached_network_image/cached_network_image.dart';

class CachedNetworkImageWidget extends StatelessWidget {
  final String imageUrl;
  final double? width;
  final double? height;
  final BoxFit fit;
  final String? placeholderAsset;

  const CachedNetworkImageWidget({
    Key? key,
    required this.imageUrl,
    this.width,
    this.height,
    this.fit = BoxFit.cover,
    this.placeholderAsset,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return CachedNetworkImage(
      imageUrl: imageUrl,
      width: width,
      height: height,
      fit: fit,
      placeholder: (context, url) => Container(
        width: width,
        height: height,
        color: Colors.grey[300],
        child: const Center(
          child: CircularProgressIndicator(),
        ),
      ),
      errorWidget: (context, url, error) => Container(
        width: width,
        height: height,
        color: Colors.grey[300],
        child: const Center(
          child: Icon(Icons.image_not_supported),
        ),
      ),
      cacheManager: CacheManager.instance,
    );
  }
}

// 사용 예제
CachedNetworkImageWidget(
  imageUrl: equipment.imageUrl,
  width: 200,
  height: 200,
  fit: BoxFit.cover,
)
```

### 10.2 썸네일/원본 분리

```dart
// lib/core/utils/image_utils.dart

class ImageUtils {
  static String getThumbnailUrl(String originalUrl) {
    // 예: https://images.danngam.com/equipment/abc123.jpg
    // → https://images.danngam.com/equipment/abc123_thumb.jpg
    final parts = originalUrl.split('.');
    if (parts.length >= 2) {
      final extension = parts.removeLast();
      return '${parts.join('.')}_thumb.$extension';
    }
    return originalUrl;
  }

  static Future<void> precacheImage(BuildContext context, String url) async {
    try {
      await precacheImage(NetworkImage(url), context);
    } catch (e) {
      debugPrint('이미지 캐시 실패: $e');
    }
  }
}

// 사용 예제
CachedNetworkImageWidget(
  imageUrl: ImageUtils.getThumbnailUrl(equipment.imageUrl),
  width: 100,
  height: 100,
)
```

### 10.3 이미지 캐시 관리

```dart
// lib/core/services/image_cache_service.dart

class ImageCacheService {
  static final _instance = ImageCacheService._();

  ImageCacheService._();

  factory ImageCacheService() {
    return _instance;
  }

  Future<void> clearCache() async {
    await CacheManager.instance.emptyCache();
    imageCache.clearCache();
    debugPrint('이미지 캐시 초기화됨');
  }

  Future<void> clearExpiredCache() async {
    // 7일 이상 된 캐시 제거
    await CacheManager.instance.emptyCache();
  }

  int? getCacheSize() {
    // 캐시 크기 조회 (선택사항)
    return null;
  }
}
```

---

## 11. 빌드 및 배포

### 11.1 Android APK 빌드

```bash
# 릴리스 APK 생성
flutter build apk --release

# 분할 APK (아키텍처별)
flutter build apk --release --split-per-abi

# 출력 경로
# build/app/outputs/flutter-apk/app-release.apk
# build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
# build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
```

### 11.2 iOS IPA 빌드

```bash
# 릴리스 빌드
flutter build ios --release

# IPA 생성 (Xcode 필수)
xcodebuild -workspace ios/Runner.xcworkspace \
  -scheme Runner \
  -configuration Release \
  -derivedDataPath build/ios_build \
  -arch arm64 \
  build

# 또는 App Store Connect 업로드
flutter build ipa --release
```

### 11.3 버전 관리 (pubspec.yaml)

```yaml
# pubspec.yaml

name: danngam_app
description: 농기계 공유 서비스 Danngam
publish_to: 'none'

version: 1.0.0+1

# 버전 형식: <major>.<minor>.<patch>+<build_number>
# 예: 1.2.3+45 (1.2.3 릴리스, 빌드 번호 45)

environment:
  sdk: '>=3.0.0 <4.0.0'
  flutter: ">=3.10.8"

dependencies:
  flutter:
    sdk: flutter
  # 다른 의존성들...

dev_dependencies:
  flutter_test:
    sdk: flutter
  # 테스트 의존성들...

flutter:
  uses-material-design: true
```

### 11.4 배포 체크리스트

```markdown
## 배포 전 확인 사항

### 기능 테스트
- [ ] 모든 기능 테스트 완료
- [ ] API 연결 정상
- [ ] 이동형/고정형 필터 정상
- [ ] 예약 → 결제 플로우 정상
- [ ] 리뷰 기능 정상

### 성능 최적화
- [ ] 빌드 시간 < 5분
- [ ] APK 크기 < 100MB
- [ ] 앱 시작 시간 < 2초
- [ ] 메모리 누수 확인

### 보안 검수
- [ ] API 키 환경 변수 확인
- [ ] HTTPS 사용 확인
- [ ] 데이터 암호화 확인
- [ ] 민감 정보 로깅 X

### 문서화
- [ ] README 최신화
- [ ] 변경 사항 기록 (CHANGELOG.md)
- [ ] 배포 노트 작성

### 배포
- [ ] 버전 번호 증가
- [ ] 버전 태그 생성 (git tag v1.0.0)
- [ ] Google Play Store / App Store 업로드
- [ ] 베타 테스트 (선택사항)
- [ ] 프로덕션 배포
```

---

## 12. 디버깅 팁

### 12.1 로깅

```dart
// lib/core/utils/logger.dart

import 'package:flutter/foundation.dart';

class AppLogger {
  static void debug(String message, [dynamic error, StackTrace? stackTrace]) {
    if (kDebugMode) {
      print('[DEBUG] $message');
      if (error != null) print('Error: $error');
      if (stackTrace != null) print('StackTrace: $stackTrace');
    }
  }

  static void info(String message) {
    if (kDebugMode) {
      print('[INFO] $message');
    }
  }

  static void warning(String message) {
    if (kDebugMode) {
      print('[WARNING] $message');
    }
  }

  static void error(String message, [dynamic error, StackTrace? stackTrace]) {
    print('[ERROR] $message');
    if (error != null) print('Error: $error');
    if (stackTrace != null) print('StackTrace: $stackTrace');
  }
}

// 사용 예제
AppLogger.debug('장비 로드 시작');
try {
  final equipments = await _repository.getEquipment();
  AppLogger.info('장비 로드 성공: ${equipments.length}개');
} on Exception catch (e, stackTrace) {
  AppLogger.error('장비 로드 실패', e, stackTrace);
}
```

### 12.2 성능 분석 (DevTools)

```bash
# DevTools 실행
flutter pub global activate devtools
devtool

# 또는 직접
flutter pub global run devtools

# Android Studio/VS Code에서 실행
# Flutter: Open DevTools 명령 사용
```

### 12.3 메모리 프로파일링

```dart
// lib/core/utils/memory_analyzer.dart

class MemoryAnalyzer {
  static Future<void> printMemoryUsage() async {
    final info = await _getMemoryInfo();
    AppLogger.info('메모리 사용량: ${info}MB');
  }

  static Future<String> _getMemoryInfo() async {
    // 플랫폼 채널을 통한 메모리 조회
    // (네이티브 코드 필요)
    return 'N/A';
  }
}
```

---

## 13. 인수 기준

이 문서가 다루어야 할 최소 요구사항입니다.

- [x] 이동형/고정형 구현 가이드 (Enum, 필터, UI) - 섹션 7 참조
- [x] MVP 패턴 구현 체크리스트 - 섹션 5.2 참조
- [x] 공통 컴포넌트 사용 예제 10개 이상 - 섹션 8 참조
  - AppButton
  - AppTextField
  - EquipmentCard
  - FilterBottomSheet
  - LoadingIndicator
  - ErrorView
  - CachedNetworkImageWidget
  - (추가 예제 가능)
- [x] 빌드/배포 가이드 - 섹션 11 참조
- [x] 로컬 상태 관리 (Provider/Context) - 섹션 14 참조
  - EquipmentProvider 예제
  - BookingProvider 예제
  - ChatProvider 예제
- [x] Mock Data 준비 - 섹션 15 참조
  - assets/data/ 폴더 구조
  - JSON 파일 로드
  - 샘플 데이터 (equipments.json, bookings.json)
- [x] LocalStorage 사용 - 섹션 16 참조
  - SharedPreferences (간단한 데이터)
  - sqflite (복잡한 데이터)
- [x] 장비 등록 개발 - 섹션 17 참조
  - 이미지 선택 (카메라, 앨범)
  - 권한 처리 (Permission Handler)
  - 다단계 폼 (Step 1-4)
- [x] 지도 통합 - 섹션 18 참조
  - Naver Map 또는 Google Map 설정
  - 마커 표시
  - 클러스터링
- [x] 채팅 개발 - 섹션 19 참조
  - 1:1 메시지 구조
  - LocalStorage에 메시지 저장
  - 미읽음 표시
- [x] 향후 백엔드 마이그레이션 - 섹션 20 참조
  - Repository 패턴으로 쉽게 전환
  - Mock → API 호출로 변경
  - 환경 변수 (.env) 기반 선택

---

## 14. 로컬 상태 관리 (Provider/Context)

### 14.1 Provider 패턴 소개

프로젝트 초기 단계에서는 **Mock Data** 기반 로컬 상태 관리를 권장합니다.
나중에 백엔드 API로 쉽게 전환할 수 있도록 Repository 패턴을 준수합니다.

**의존성 추가** (pubspec.yaml):
```yaml
dependencies:
  flutter:
    sdk: flutter
  provider: ^6.0.0           # 상태 관리
  riverpod: ^2.0.0           # (선택사항) 더 강력한 상태 관리
```

### 14.2 EquipmentProvider 구현 예제

```dart
// lib/core/providers/equipment_provider.dart

import 'package:flutter/foundation.dart';
import 'package:danngam/features/equipment/domain/entities/equipment.dart';

class EquipmentProvider extends ChangeNotifier {
  final EquipmentRepository _repository;

  List<Equipment> _equipments = [];
  List<Equipment> _filteredEquipments = [];
  bool _isLoading = false;
  String? _errorMessage;

  EquipmentProvider(this._repository);

  // Getters
  List<Equipment> get equipments => _filteredEquipments;
  bool get isLoading => _isLoading;
  String? get errorMessage => _errorMessage;

  // 장비 로드 (타입별)
  Future<void> loadEquipment({
    required EquipmentType type,
    String? searchQuery,
  }) async {
    try {
      _isLoading = true;
      _errorMessage = null;
      notifyListeners();

      _equipments = await _repository.getEquipment(
        type: type,
        searchQuery: searchQuery,
      );

      _filteredEquipments = _equipments;
      _isLoading = false;
      notifyListeners();
    } on Exception catch (e) {
      _errorMessage = e.toString();
      _isLoading = false;
      notifyListeners();
    }
  }

  // 필터 적용
  void applyFilter({
    required double maxPrice,
    required double minRating,
    required String? category,
  }) {
    _filteredEquipments = _equipments.where((e) {
      bool matchPrice = e.price <= maxPrice;
      bool matchRating = e.rating >= minRating;
      bool matchCategory = category == null || e.category == category;

      return matchPrice && matchRating && matchCategory;
    }).toList();

    notifyListeners();
  }

  // 검색
  void search(String query) {
    if (query.isEmpty) {
      _filteredEquipments = _equipments;
    } else {
      _filteredEquipments = _equipments
          .where((e) => e.name.toLowerCase().contains(query.toLowerCase()))
          .toList();
    }
    notifyListeners();
  }

  // 찜하기
  void toggleFavorite(String equipmentId) {
    // 로컬 저장소 또는 상태에 저장
    notifyListeners();
  }
}
```

### 14.3 BookingProvider 구현 예제

```dart
// lib/core/providers/booking_provider.dart

class BookingProvider extends ChangeNotifier {
  final BookingRepository _repository;

  Booking? _currentBooking;
  List<Booking> _userBookings = [];
  bool _isLoading = false;

  BookingProvider(this._repository);

  Booking? get currentBooking => _currentBooking;
  List<Booking> get userBookings => _userBookings;
  bool get isLoading => _isLoading;

  // 예약 생성
  Future<void> createBooking({
    required String equipmentId,
    required DateTime startDate,
    required DateTime endDate,
    required String? notes,
  }) async {
    try {
      _isLoading = true;
      notifyListeners();

      _currentBooking = await _repository.createBooking(
        equipmentId: equipmentId,
        startDate: startDate,
        endDate: endDate,
        notes: notes,
      );

      _isLoading = false;
      notifyListeners();
    } on Exception {
      _isLoading = false;
      notifyListeners();
      rethrow;
    }
  }

  // 사용자 예약 목록 로드
  Future<void> loadUserBookings() async {
    try {
      _isLoading = true;
      notifyListeners();

      _userBookings = await _repository.getUserBookings();

      _isLoading = false;
      notifyListeners();
    } on Exception {
      _isLoading = false;
      notifyListeners();
      rethrow;
    }
  }

  // 예약 취소
  Future<void> cancelBooking(String bookingId) async {
    try {
      _isLoading = true;
      notifyListeners();

      await _repository.cancelBooking(bookingId);

      _userBookings.removeWhere((b) => b.id == bookingId);

      _isLoading = false;
      notifyListeners();
    } on Exception {
      _isLoading = false;
      notifyListeners();
      rethrow;
    }
  }
}
```

### 14.4 ChatProvider 구현 예제

```dart
// lib/core/providers/chat_provider.dart

class ChatProvider extends ChangeNotifier {
  final ChatRepository _repository;

  List<ChatRoom> _chatRooms = [];
  List<Message> _currentMessages = [];
  bool _isLoading = false;

  ChatProvider(this._repository);

  List<ChatRoom> get chatRooms => _chatRooms;
  List<Message> get currentMessages => _currentMessages;
  bool get isLoading => _isLoading;

  // 채팅 목록 로드
  Future<void> loadChatRooms() async {
    try {
      _isLoading = true;
      notifyListeners();

      _chatRooms = await _repository.getChatRooms();

      _isLoading = false;
      notifyListeners();
    } on Exception {
      _isLoading = false;
      notifyListeners();
      rethrow;
    }
  }

  // 채팅 상세 로드
  Future<void> loadMessages(String userId) async {
    try {
      _isLoading = true;
      notifyListeners();

      _currentMessages = await _repository.getMessages(userId);

      _isLoading = false;
      notifyListeners();
    } on Exception {
      _isLoading = false;
      notifyListeners();
      rethrow;
    }
  }

  // 메시지 전송
  Future<void> sendMessage({
    required String userId,
    required String content,
  }) async {
    try {
      final message = await _repository.sendMessage(
        userId: userId,
        content: content,
      );

      _currentMessages.add(message);
      notifyListeners();
    } on Exception {
      notifyListeners();
      rethrow;
    }
  }
}
```

### 14.5 Provider 등록 및 사용

```dart
// lib/main.dart

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await AppConfig.instance.load();
  setupServiceLocator();
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return MultiProvider(
      providers: [
        ChangeNotifierProvider(
          create: (_) => EquipmentProvider(getIt<EquipmentRepository>()),
        ),
        ChangeNotifierProvider(
          create: (_) => BookingProvider(getIt<BookingRepository>()),
        ),
        ChangeNotifierProvider(
          create: (_) => ChatProvider(getIt<ChatRepository>()),
        ),
      ],
      child: MaterialApp(
        home: SplashScreen(),
      ),
    );
  }
}

// 화면에서 사용
class MainScreen extends StatefulWidget {
  const MainScreen({Key? key}) : super(key: key);

  @override
  State<MainScreen> createState() => _MainScreenState();
}

class _MainScreenState extends State<MainScreen> {
  @override
  void initState() {
    super.initState();
    // 초기 데이터 로드
    context.read<EquipmentProvider>().loadEquipment(
      type: EquipmentType.MOBILE,
    );
  }

  @override
  Widget build(BuildContext context) {
    return Consumer<EquipmentProvider>(
      builder: (context, provider, child) {
        if (provider.isLoading) {
          return const Center(child: CircularProgressIndicator());
        }

        if (provider.errorMessage != null) {
          return ErrorView(message: provider.errorMessage!);
        }

        return ListView.builder(
          itemCount: provider.equipments.length,
          itemBuilder: (context, index) {
            return EquipmentCard(
              equipment: provider.equipments[index],
              onTap: () => _navigateToDetail(context, index),
            );
          },
        );
      },
    );
  }

  void _navigateToDetail(BuildContext context, int index) {
    final equipment = context.read<EquipmentProvider>().equipments[index];
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => EquipmentDetailScreen(
          equipmentId: equipment.id,
        ),
      ),
    );
  }
}
```

---

## 15. Mock Data 준비

### 15.1 Mock Data 구조

```
assets/
├── data/
│   ├── equipments.json
│   ├── bookings.json
│   ├── users.json
│   ├── reviews.json
│   └── chat_messages.json
└── images/
    ├── equipment1.jpg
    ├── equipment2.jpg
    └── ...
```

### 15.2 Mock 데이터 파일 (JSON)

**assets/data/equipments.json**:
```json
[
  {
    "id": "eq_001",
    "name": "트랙터 80마력",
    "category": "TRACTOR",
    "type": "MOBILE",
    "description": "최신형 트랙터로 밭갈이 및 경운에 최적화되어 있습니다.",
    "price": 150000.0,
    "hourlyPrice": 25000.0,
    "imageUrl": "assets/images/equipment1.jpg",
    "images": ["assets/images/equipment1.jpg", "assets/images/equipment1_2.jpg"],
    "rating": 4.8,
    "reviewCount": 42,
    "providerId": "provider_001",
    "providerName": "이농부",
    "latitude": 37.25634,
    "longitude": 127.73156,
    "availableStartTime": "08:00",
    "availableEndTime": "18:00",
    "createdAt": "2026-01-20T10:00:00Z"
  },
  {
    "id": "eq_002",
    "name": "콤바인 4조식",
    "category": "COMBINE",
    "type": "MOBILE",
    "description": "4조식 최신형 콤바인으로 효율성이 뛰어납니다.",
    "price": 200000.0,
    "hourlyPrice": 30000.0,
    "imageUrl": "assets/images/equipment2.jpg",
    "rating": 4.9,
    "reviewCount": 28,
    "providerId": "provider_002",
    "providerName": "김농부",
    "latitude": 37.28456,
    "longitude": 127.71234,
    "availableStartTime": "07:00",
    "availableEndTime": "19:00",
    "createdAt": "2026-01-15T12:00:00Z"
  }
]
```

**assets/data/bookings.json**:
```json
[
  {
    "id": "book_001",
    "equipmentId": "eq_001",
    "equipmentName": "트랙터 80마력",
    "userId": "user_001",
    "startDate": "2026-02-15",
    "endDate": "2026-02-17",
    "startTime": "08:00",
    "endTime": "16:00",
    "totalPrice": 324000.0,
    "status": "CONFIRMED",
    "createdAt": "2026-02-14T10:00:00Z"
  }
]
```

### 15.3 Mock 데이터 로드

```dart
// lib/core/services/mock_data_service.dart

class MockDataService {
  static Future<List<Equipment>> loadEquipments() async {
    final String data = await rootBundle.loadString('assets/data/equipments.json');
    final List<dynamic> json = jsonDecode(data);
    return json.map((e) => Equipment.fromJson(e)).toList();
  }

  static Future<List<Booking>> loadBookings() async {
    final String data = await rootBundle.loadString('assets/data/bookings.json');
    final List<dynamic> json = jsonDecode(data);
    return json.map((e) => Booking.fromJson(e)).toList();
  }
}
```

### 15.4 pubspec.yaml 수정

```yaml
flutter:
  assets:
    - assets/data/
    - assets/images/
```

---

## 16. LocalStorage 사용 (SharedPreferences / sqflite)

### 16.1 SharedPreferences (간단한 데이터)

**의존성 추가**:
```yaml
dependencies:
  shared_preferences: ^2.0.0
```

**구현**:
```dart
// lib/core/services/local_storage_service.dart

class LocalStorageService {
  static const String _userKey = 'user_data';
  static const String _tokenKey = 'auth_token';
  static const String _favoritesKey = 'favorites';

  static final SharedPreferences _prefs = getIt<SharedPreferences>();

  // 토큰 저장
  static Future<void> saveToken(String token) async {
    await _prefs.setString(_tokenKey, token);
  }

  // 토큰 조회
  static String? getToken() {
    return _prefs.getString(_tokenKey);
  }

  // 사용자 정보 저장
  static Future<void> saveUser(User user) async {
    final json = jsonEncode(user.toJson());
    await _prefs.setString(_userKey, json);
  }

  // 사용자 정보 조회
  static User? getUser() {
    final json = _prefs.getString(_userKey);
    if (json == null) return null;
    return User.fromJson(jsonDecode(json));
  }

  // 찜한 장비 저장
  static Future<void> addFavorite(String equipmentId) async {
    final favorites = getFavorites();
    favorites.add(equipmentId);
    await _prefs.setStringList(_favoritesKey, favorites);
  }

  // 찜 목록 조회
  static List<String> getFavorites() {
    return _prefs.getStringList(_favoritesKey) ?? [];
  }

  // 찜 제거
  static Future<void> removeFavorite(String equipmentId) async {
    final favorites = getFavorites();
    favorites.remove(equipmentId);
    await _prefs.setStringList(_favoritesKey, favorites);
  }

  // 로그아웃
  static Future<void> clear() async {
    await _prefs.clear();
  }
}
```

### 16.2 sqflite (복잡한 데이터)

**의존성 추가**:
```yaml
dependencies:
  sqflite: ^2.0.0
  path: ^1.8.0
```

**구현**:
```dart
// lib/core/database/database_helper.dart

class DatabaseHelper {
  static const String _databaseName = 'danngam.db';
  static const int _databaseVersion = 1;

  static final DatabaseHelper _instance = DatabaseHelper._internal();

  factory DatabaseHelper() => _instance;

  DatabaseHelper._internal();

  late Database _database;

  Future<Database> get database async {
    _database = await _initDatabase();
    return _database;
  }

  Future<Database> _initDatabase() async {
    final String path = join(
      await getDatabasesPath(),
      _databaseName,
    );

    return openDatabase(
      path,
      version: _databaseVersion,
      onCreate: _onCreate,
    );
  }

  Future<void> _onCreate(Database db, int version) async {
    // 메시지 테이블
    await db.execute('''
      CREATE TABLE messages (
        id TEXT PRIMARY KEY,
        userId TEXT,
        content TEXT,
        timestamp INTEGER,
        isRead INTEGER
      )
    ''');

    // 찜한 장비 테이블
    await db.execute('''
      CREATE TABLE favorites (
        id TEXT PRIMARY KEY,
        equipmentId TEXT,
        addedAt INTEGER
      )
    ''');

    // 임시 예약 정보
    await db.execute('''
      CREATE TABLE draft_bookings (
        id TEXT PRIMARY KEY,
        equipmentId TEXT,
        startDate TEXT,
        endDate TEXT,
        createdAt INTEGER
      )
    ''');
  }

  // 메시지 저장
  Future<void> saveMessage(Message message) async {
    final db = await database;
    await db.insert(
      'messages',
      {
        'id': message.id,
        'userId': message.userId,
        'content': message.content,
        'timestamp': message.timestamp.millisecondsSinceEpoch,
        'isRead': message.isRead ? 1 : 0,
      },
      conflictAlgorithm: ConflictAlgorithm.replace,
    );
  }

  // 메시지 조회
  Future<List<Message>> getMessages(String userId) async {
    final db = await database;
    final List<Map<String, dynamic>> maps = await db.query(
      'messages',
      where: 'userId = ?',
      whereArgs: [userId],
      orderBy: 'timestamp DESC',
    );
    return maps.map((m) => Message.fromMap(m)).toList();
  }

  // 찜하기
  Future<void> addFavorite(String equipmentId) async {
    final db = await database;
    await db.insert(
      'favorites',
      {
        'id': '${equipmentId}_${DateTime.now().timestamp}',
        'equipmentId': equipmentId,
        'addedAt': DateTime.now().millisecondsSinceEpoch,
      },
    );
  }

  // 찜 목록
  Future<List<String>> getFavorites() async {
    final db = await database;
    final List<Map<String, dynamic>> maps = await db.query('favorites');
    return maps.map((m) => m['equipmentId'] as String).toList();
  }
}
```

---

## 17. 장비 등록 개발

### 17.1 카메라 권한 및 이미지 선택

**의존성 추가**:
```yaml
dependencies:
  image_picker: ^0.8.0
  permission_handler: ^11.0.0
```

**구현**:
```dart
// lib/features/equipment/presentation/screens/equipment_registration_screen.dart

class EquipmentRegistrationScreen extends StatefulWidget {
  const EquipmentRegistrationScreen({Key? key}) : super(key: key);

  @override
  State<EquipmentRegistrationScreen> createState() =>
      _EquipmentRegistrationScreenState();
}

class _EquipmentRegistrationScreenState
    extends State<EquipmentRegistrationScreen> {
  final ImagePicker _imagePicker = ImagePicker();
  List<XFile> _selectedImages = [];
  int _currentStep = 1; // 1~4

  // 사진 선택
  Future<void> _pickImage() async {
    final status = await Permission.camera.request();
    if (!status.isGranted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('카메라 권한이 필요합니다')),
      );
      return;
    }

    final image = await _imagePicker.pickImage(source: ImageSource.camera);
    if (image != null) {
      setState(() => _selectedImages.add(image));
    }
  }

  // 앨범에서 선택
  Future<void> _pickFromGallery() async {
    final status = await Permission.photos.request();
    if (!status.isGranted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('앨범 권한이 필요합니다')),
      );
      return;
    }

    final images = await _imagePicker.pickMultiImage();
    if (images.isNotEmpty) {
      setState(() => _selectedImages.addAll(images));
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('장비 등록 ($_currentStep/4)'),
      ),
      body: _buildCurrentStep(),
    );
  }

  Widget _buildCurrentStep() {
    switch (_currentStep) {
      case 1:
        return _buildStep1ImageSelection();
      case 2:
        return _buildStep2BasicInfo();
      case 3:
        return _buildStep3Location();
      case 4:
        return _buildStep4Pricing();
      default:
        return const SizedBox();
    }
  }

  Widget _buildStep1ImageSelection() {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          const Text('장비 이미지를 선택해주세요'),
          const SizedBox(height: 24),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceEvenly,
            children: [
              ElevatedButton.icon(
                icon: const Icon(Icons.camera_alt),
                label: const Text('카메라'),
                onPressed: _pickImage,
              ),
              ElevatedButton.icon(
                icon: const Icon(Icons.photo_library),
                label: const Text('앨범'),
                onPressed: _pickFromGallery,
              ),
            ],
          ),
          const SizedBox(height: 24),
          if (_selectedImages.isNotEmpty)
            Wrap(
              spacing: 8,
              runSpacing: 8,
              children: _selectedImages.map((image) {
                return Stack(
                  children: [
                    Image.file(
                      File(image.path),
                      width: 100,
                      height: 100,
                      fit: BoxFit.cover,
                    ),
                    Positioned(
                      top: -8,
                      right: -8,
                      child: IconButton(
                        icon: const Icon(Icons.close_circle),
                        color: Colors.red,
                        onPressed: () {
                          setState(() => _selectedImages.remove(image));
                        },
                      ),
                    ),
                  ],
                );
              }).toList(),
            ),
          const SizedBox(height: 24),
          SizedBox(
            width: double.infinity,
            child: ElevatedButton(
              onPressed: _selectedImages.isNotEmpty
                  ? () => setState(() => _currentStep = 2)
                  : null,
              child: const Text('다음'),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStep2BasicInfo() {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          // ... Step 2 폼 필드들
          SizedBox(
            width: double.infinity,
            child: Row(
              children: [
                Expanded(
                  child: ElevatedButton(
                    onPressed: () => setState(() => _currentStep = 1),
                    child: const Text('이전'),
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: ElevatedButton(
                    onPressed: () => setState(() => _currentStep = 3),
                    child: const Text('다음'),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStep3Location() {
    return const SizedBox();
  }

  Widget _buildStep4Pricing() {
    return const SizedBox();
  }
}
```

### 17.2 위치 설정 (지도 통합)

**의존성 추가**:
```yaml
dependencies:
  naver_map_plugin: ^2.0.0  # 또는 google_maps_flutter
  geolocator: ^9.0.0
```

---

## 18. 지도 통합

### 18.1 Naver Map 설정

**Android (android/app/build.gradle)**:
```gradle
manifestPlaceholders = [NAVER_MAP_API_KEY: "YOUR_API_KEY"]
```

**iOS (ios/Runner/Info.plist)**:
```xml
<key>com.naver.maps.appkey</key>
<string>YOUR_API_KEY</string>
```

**구현**:
```dart
// lib/features/map/presentation/screens/map_search_screen.dart

class MapSearchScreen extends StatefulWidget {
  const MapSearchScreen({Key? key}) : super(key: key);

  @override
  State<MapSearchScreen> createState() => _MapSearchScreenState();
}

class _MapSearchScreenState extends State<MapSearchScreen> {
  late NaverMapController _mapController;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('지도 검색')),
      body: Stack(
        children: [
          NaverMap(
            onMapCreated: (controller) => _mapController = controller,
            initialCameraPosition: CameraPosition(
              target: LatLng(37.25634, 127.73156),
              zoom: 15,
            ),
            markers: _buildMarkers(),
            clusterMarkerBuilder: _buildClusterMarker,
          ),
          Positioned(
            bottom: 16,
            left: 16,
            right: 16,
            child: Container(
              color: Colors.white,
              child: Column(
                children: [
                  // 주변 장비 목록
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  List<Marker> _buildMarkers() {
    // 장비 데이터에서 마커 생성
    return [];
  }

  Widget _buildClusterMarker(List<Marker> markers) {
    return Container(
      decoration: BoxDecoration(
        color: Colors.blue,
        shape: BoxShape.circle,
      ),
      child: Center(
        child: Text(
          '${markers.length}',
          style: const TextStyle(
            color: Colors.white,
            fontWeight: FontWeight.bold,
          ),
        ),
      ),
    );
  }
}
```

---

## 19. 채팅 개발

### 19.1 메시지 모델 정의

```dart
// lib/features/chat/domain/entities/message.dart

class Message {
  final String id;
  final String userId;
  final String content;
  final DateTime timestamp;
  final bool isRead;
  final String? imageUrl;

  Message({
    required this.id,
    required this.userId,
    required this.content,
    required this.timestamp,
    required this.isRead,
    this.imageUrl,
  });
}

class ChatRoom {
  final String id;
  final String userId;
  final String userName;
  final String? userProfileUrl;
  final String lastMessage;
  final DateTime lastMessageTime;
  final int unreadCount;

  ChatRoom({
    required this.id,
    required this.userId,
    required this.userName,
    this.userProfileUrl,
    required this.lastMessage,
    required this.lastMessageTime,
    required this.unreadCount,
  });
}
```

### 19.2 ChatRepository (로컬 저장소)

```dart
// lib/features/chat/data/repositories/chat_repository_impl.dart

class ChatRepositoryImpl implements ChatRepository {
  final DatabaseHelper _databaseHelper;
  final LocalStorageService _localStorage;

  ChatRepositoryImpl(this._databaseHelper, this._localStorage);

  @override
  Future<void> sendMessage({
    required String userId,
    required String content,
  }) async {
    final message = Message(
      id: 'msg_${DateTime.now().timestamp}',
      userId: userId,
      content: content,
      timestamp: DateTime.now(),
      isRead: true,
    );

    // 로컬 DB에 저장
    await _databaseHelper.saveMessage(message);

    // 추후 백엔드 API로 전환
    // await _apiClient.post('/messages', data: message.toJson());
  }

  @override
  Future<List<Message>> getMessages(String userId) async {
    return await _databaseHelper.getMessages(userId);
  }

  @override
  Future<List<ChatRoom>> getChatRooms() async {
    // Mock 데이터 또는 로컬 DB에서 조회
    return [
      ChatRoom(
        id: 'room_001',
        userId: 'user_001',
        userName: '이농부',
        lastMessage: '네, 예약 날짜가 맞습니다',
        lastMessageTime: DateTime.now().subtract(const Duration(hours: 2)),
        unreadCount: 1,
      ),
    ];
  }
}
```

### 19.3 ChatDetailScreen UI

```dart
// lib/features/chat/presentation/screens/chat_detail_screen.dart

class ChatDetailScreen extends StatefulWidget {
  final String userId;

  const ChatDetailScreen({
    Key? key,
    required this.userId,
  }) : super(key: key);

  @override
  State<ChatDetailScreen> createState() => _ChatDetailScreenState();
}

class _ChatDetailScreenState extends State<ChatDetailScreen> {
  final TextEditingController _messageController = TextEditingController();
  late ChatProvider _chatProvider;

  @override
  void initState() {
    super.initState();
    _chatProvider = context.read<ChatProvider>();
    _chatProvider.loadMessages(widget.userId);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('채팅'),
        actions: [
          IconButton(
            icon: const Icon(Icons.more_vert),
            onPressed: () {
              // 옵션 메뉴
            },
          ),
        ],
      ),
      body: Column(
        children: [
          Expanded(
            child: Consumer<ChatProvider>(
              builder: (context, provider, child) {
                if (provider.isLoading) {
                  return const Center(child: CircularProgressIndicator());
                }

                return ListView.builder(
                  reverse: true,
                  itemCount: provider.currentMessages.length,
                  itemBuilder: (context, index) {
                    final message = provider.currentMessages[index];
                    return _buildMessageBubble(message);
                  },
                );
              },
            ),
          ),
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Row(
              children: [
                IconButton(
                  icon: const Icon(Icons.add),
                  onPressed: () {
                    // 파일 첨부
                  },
                ),
                Expanded(
                  child: TextField(
                    controller: _messageController,
                    decoration: InputDecoration(
                      hintText: '메시지를 입력하세요',
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(24),
                      ),
                      contentPadding: const EdgeInsets.symmetric(
                        horizontal: 16,
                        vertical: 12,
                      ),
                    ),
                  ),
                ),
                IconButton(
                  icon: const Icon(Icons.send),
                  onPressed: _sendMessage,
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildMessageBubble(Message message) {
    final isCurrentUser = message.userId == 'current_user'; // 실제 사용자 ID 비교

    return Align(
      alignment: isCurrentUser ? Alignment.centerRight : Alignment.centerLeft,
      child: Container(
        margin: const EdgeInsets.all(8),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        decoration: BoxDecoration(
          color: isCurrentUser ? Colors.blue : Colors.grey[300],
          borderRadius: BorderRadius.circular(12),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.end,
          children: [
            Text(
              message.content,
              style: TextStyle(
                color: isCurrentUser ? Colors.white : Colors.black,
              ),
            ),
            const SizedBox(height: 4),
            Text(
              _formatTime(message.timestamp),
              style: TextStyle(
                fontSize: 12,
                color: isCurrentUser ? Colors.white70 : Colors.black54,
              ),
            ),
          ],
        ),
      ),
    );
  }

  String _formatTime(DateTime time) {
    return '${time.hour}:${time.minute.toString().padLeft(2, '0')}';
  }

  void _sendMessage() async {
    if (_messageController.text.isEmpty) return;

    await _chatProvider.sendMessage(
      userId: widget.userId,
      content: _messageController.text,
    );

    _messageController.clear();
  }

  @override
  void dispose() {
    _messageController.dispose();
    super.dispose();
  }
}
```

---

## 20. 향후 백엔드 마이그레이션

### 20.1 Repository 패턴 활용

현재의 로컬 저장소 기반 Repository를 나중에 API 기반으로 변환할 때는 구현부만 변경하면 됩니다.

**변환 전** (로컬 Mock Data):
```dart
class EquipmentRepositoryImpl implements EquipmentRepository {
  final LocalDataSource _localDataSource;

  @override
  Future<List<Equipment>> getEquipment({...}) async {
    return await _localDataSource.getEquipment(...);
  }
}
```

**변환 후** (API):
```dart
class EquipmentRepositoryImpl implements EquipmentRepository {
  final RemoteDataSource _remoteDataSource;

  @override
  Future<List<Equipment>> getEquipment({...}) async {
    return await _remoteDataSource.getEquipment(...);  // API 호출
  }
}
```

### 20.2 환경 변수 기반 선택

```dart
// lib/core/config/env.dart

class AppConfig {
  static final instance = AppConfig._();

  late final String backendType; // 'mock' 또는 'api'

  Future<void> load() async {
    await dotenv.load();
    backendType = dotenv.env['BACKEND_TYPE'] ?? 'mock';
  }
}

// lib/core/di/service_locator.dart

void setupServiceLocator() {
  final backendType = AppConfig.instance.backendType;

  if (backendType == 'mock') {
    // Mock 데이터 소스 등록
    getIt.registerSingleton<EquipmentRepository>(
      EquipmentRepositoryImpl(getIt<LocalDataSource>()),
    );
  } else {
    // API 기반 소스 등록
    getIt.registerSingleton<EquipmentRepository>(
      EquipmentRepositoryImpl(getIt<RemoteDataSource>()),
    );
  }
}
```

### 20.3 API 마이그레이션 체크리스트

```markdown
## API 마이그레이션 준비 사항

### 백엔드 개발 완료
- [ ] 모든 API 엔드포인트 구현 및 테스트
- [ ] OpenAPI 문서 제공
- [ ] 인증 (JWT, OAuth) 구현
- [ ] CORS 설정

### 프론트엔드 수정
- [ ] RemoteDataSource 구현
- [ ] 환경 변수에서 API_BASE_URL 설정
- [ ] 인증 인터셉터 설정
- [ ] 에러 처리 로직 수정

### 테스트
- [ ] 단위 테스트 업데이트
- [ ] 통합 테스트 실행
- [ ] 성능 테스트 (로컬 vs API)
- [ ] 보안 테스트

### 배포
- [ ] 스테이징 환경에서 테스트
- [ ] 배포 후 모니터링
- [ ] 롤백 계획 수립
```

---

## 추가 리소스

### 공식 문서
- [Flutter 공식 문서](https://flutter.dev/docs)
- [Dart 언어 투어](https://dart.dev/guides/language/language-tour)
- [Material Design 가이드](https://material.io/design)

### 유용한 패키지
- `get_it`: 의존성 주입
- `dio`: HTTP 클라이언트
- `cached_network_image`: 이미지 캐싱
- `flutter_dotenv`: 환경 변수
- `freezed`: 불변 클래스 생성

### 팁
- 자주 저장하고 `flutter pub get` 실행
- 큰 변경 후에는 `flutter clean` 실행
- VSCode에서 `Dart: Sort Members` 사용으로 코드 정리
- 정기적으로 `flutter analyze` 실행

---

**마지막 수정**: 2026-02-14
**버전**: 1.1 (장비 등록, 지도, 채팅 기능 추가)
